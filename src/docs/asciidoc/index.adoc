= Backend API
:doctype: book
:toc: left
:toclevels: 3
:sectnums:
:sectanchors:
:sectlinks:
:icons: font
:source-highlighter: highlightjs
:stylesdir: styles
:stylesheet: custom.css
:linkcss:
:snippets: {snippets}

== Overview

[cols="1,3",options="header"]
|===
|항목 |설명
|Base URL|`http://localhost`
|Docs|`/docs`
|인증|**Cookie 방식 권장** (`login-cookie` / `refresh-cookie`) + Bearer 대안
|SSE|`GET /api/sse/subscribe`
|===

[TIP]
====
이 문서는 Spring REST Docs가 테스트 실행 시 생성한 스니펫(`build/generated-snippets`)을 include 해서 만들어집니다.

- 스니펫 생성: `./gradlew test`
- 문서 생성: `./gradlew asciidoctor`
- 결과: `build/docs/asciidoc/index.html`
====

=== 인증 방식 선택 가이드

==== Cookie 방식(권장)
- 브라우저 환경에서 가장 자연스럽고, **SSE에도 그대로 적용**하기 쉽습니다.
- 프론트는 `withCredentials: true`로 쿠키를 자동 전송합니다.
- Access 만료 시 `refresh-cookie`로 재발급 후 원요청을 재시도하는 패턴이 일반적입니다.

==== Bearer 방식(대안)
- 모바일 앱 / 서버-서버 호출 등 “쿠키를 쓰기 애매한 환경”에서 사용합니다.
- `Authorization: Bearer <accessToken>` 헤더를 사용합니다.

=== Quick Start (Bearer)

[source,bash]
----
# 1) 로그인 → accessToken
curl -s -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"1234"}' \
  http://localhost/api/auth/login

# 2) Authorization 헤더로 호출
curl -i -H "Authorization: Bearer <accessToken>" http://localhost/api/me
----

=== Quick Start (Cookie)

[source,bash]
----
# 1) 로그인(쿠키 저장)
curl -i -c cookies.txt \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"1234"}' \
  http://localhost/api/auth/login-cookie

# 2) 내 정보
curl -i -b cookies.txt http://localhost/api/me

# 3) refresh-cookie (Access 만료 시)
curl -i -b cookies.txt -c cookies.txt http://localhost/api/auth/refresh-cookie

# 4) logout-cookie
curl -i -b cookies.txt http://localhost/api/auth/logout-cookie
----

=== 프론트(axios)에서 권장하는 401 처리 흐름

[IMPORTANT]
====
권장 패턴(쿠키 인증 기준):

1) API 호출 중 401 발생
2) `POST /api/auth/refresh-cookie` 호출 (쿠키 자동 전송)
3) refresh 성공 시: 원래 실패한 요청을 **딱 1회 재시도**
4) refresh 실패(401/403 등) 시: 세션 만료로 판단하고 로그인 페이지로 이동

주의:
- refresh 요청이 동시 다발적으로 발생하지 않도록 “refresh 큐/락(한 번만 실행)”을 권장합니다.
- 무한 재시도 방지를 위해, 같은 요청은 1회만 재시도하도록 제한합니다.
====

=== 운영 환경 쿠키 설정 (HTTPS 중요)

[IMPORTANT]
====
운영이 HTTPS인데 `Secure=false`면 브라우저가 쿠키를 막아 인증이 깨질 수 있습니다.

- 동일 오리진 SPA: 보통 `SameSite=Lax` 권장
- 프론트/백 도메인 분리(크로스사이트): `SameSite=None` + `Secure=true`가 필요할 수 있음
====

=== SSE 운영 팁 (Nginx/Proxy)

[IMPORTANT]
====
SSE는 “연결을 오래 유지”하므로 프록시 설정이 중요합니다.

권장 설정(요약):
- `proxy_buffering off` : 버퍼링 비활성화(실시간 전송)
- `proxy_read_timeout` 충분히 크게 (예: 3600s)
- 필요 시 `X-Accel-Buffering: no` 헤더도 고려

또한:
- 클라이언트는 네트워크 단절에 대비해 자동 재연결(리트라이)을 권장합니다.
- 인증은 쿠키 기반이면 SSE에도 동일하게 적용됩니다(`credentials: include`).
====

=== 공통 에러 응답 안내(가이드)

[NOTE]
====
에러 응답은 보통 아래와 같은 형태를 가집니다(프로젝트 구현에 따라 필드가 다를 수 있음).

[source,json]
----
{
  "code": "AUTH_UNAUTHORIZED",
  "message": "인증이 필요합니다."
}
----
====

---

== Usage Scenarios (실전 사용 흐름)

이 섹션은 API를 “목록”이 아니라 “실제 제품 흐름”으로 설명합니다.
(각 API의 상세 스펙은 아래 1~12 섹션의 REST Docs 스니펫을 참고하세요.)

=== 시나리오 1: 회원가입 → 로그인(Cookie) → 내 정보 조회

[source,bash]
----
# 0) 회원가입 (필드: email, handle, password, name)
curl -i -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","handle":"user1","password":"1234","name":"User One"}' \
  http://localhost/api/users

# 1) 로그인(쿠키 저장)
curl -i -c cookies.txt \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"1234"}' \
  http://localhost/api/auth/login-cookie

# 2) 내 정보 조회
curl -i -b cookies.txt http://localhost/api/me

# 3) 로그아웃
curl -i -b cookies.txt http://localhost/api/auth/logout-cookie
----

[NOTE]
====
- 브라우저(SPA)에서는 쿠키 자동 저장이므로 `cookies.txt`는 필요 없습니다.
- 프론트는 반드시 `withCredentials: true`를 켜야 합니다.
====

---

=== 시나리오 2: 파일 업로드 → 게시글 생성 → 피드 확인

권장 흐름:
1) 파일 업로드로 `fileId` 확보
2) 게시글 생성 시 `imageFileIds`에 첨부
3) 피드에서 확인

[source,bash]
----
# (전제) 로그인 후 cookies.txt가 있다고 가정

# 1) 파일 업로드 (multipart POST /api/files, part name: file)
# - 응답에서 fileId를 확보
curl -i -b cookies.txt \
  -F "file=@./sample.png" \
  http://localhost/api/files

# 2) 게시글 생성 (POST /api/posts)
# - 권장: imageFileIds 사용
curl -i -b cookies.txt -H "Content-Type: application/json" \
  -d '{"content":"hello","imageFileIds":["<fileId>"],"visibility":"FOLLOWERS"}' \
  http://localhost/api/posts

# 3) 피드 조회 (GET /api/feed?size=20)
curl -i -b cookies.txt "http://localhost/api/feed?size=20"
----

[NOTE]
====
- visibility 값: `ALL | FOLLOWERS | PRIVATE`
- 피드는 cursor 기반 페이징을 지원합니다. (다음 페이지: `cursor`를 응답 값으로 넣어 재호출)
====

---

=== 시나리오 3: 쿠키 기반 채팅 실시간(메시지/삭제) + 알림 실시간(SSE)

이 서버는 SSE 이벤트로 실시간 신호를 보내고, 화면 데이터는 REST API 재조회로 동기화하는 패턴을 권장합니다.

==== 3-1) SSE 구독 (Cookie 권장)

SSE 엔드포인트:
----
GET /api/sse/subscribe
----

- 쿠키 인증이면 SSE에도 동일하게 쿠키가 전송되어 인증됩니다.
- 연결 직후 서버는 `connected` 이벤트를 한 번 보냅니다.
- 클라이언트는 필요 시 `Last-Event-ID` 헤더로 누락 이벤트를 replay 받을 수 있습니다.

==== 3-2) DIRECT 대화방 생성/조회

[source,bash]
----
# 상대 userId로 DIRECT 대화방 생성/조회
curl -i -b cookies.txt -H "Content-Type: application/json" \
  -d '{"targetUserId":"<targetUserId>"}' \
  http://localhost/api/conversations/direct
----

==== 3-3) 메시지 목록 조회 (화면 동기화용)

[source,bash]
----
# 최근 메시지 조회 (cursor 기반이면 cursor/size를 사용)
curl -i -b cookies.txt \
  "http://localhost/api/conversations/<conversationId>/messages?size=20"
----

==== 3-4) 메시지 전송

[source,bash]
----
curl -i -b cookies.txt -H "Content-Type: application/json" \
  -d '{"content":"안녕!","attachmentIds":[]}' \
  "http://localhost/api/conversations/<conversationId>/messages"
----

---

==== 3-5) SSE 이벤트 종류(서버가 실제로 보내는 이벤트)

서버는 아래 이벤트를 전송합니다.

[cols="1,2,2",options="header"]
|===
|event name |언제 발생 |클라이언트 권장 동작
|`connected` |구독 직후 연결 확인 |상태 표시(connected), 필요 시 초기 동기화 트리거
|`message-created` |상대가 메시지 전송 |해당 대화방 메시지 목록 재조회(또는 뱃지/리스트 갱신)
|`message-deleted` |메시지 삭제 발생 |해당 대화방 메시지 목록 재조회
|`notification-created` |새 알림 생성 |알림 목록 재조회 / 뱃지 카운트 갱신
|`pin-created` |핀 생성 |해당 대화방 핀 목록 재조회(또는 상단 pinned UI 즉시 갱신)
|===

[IMPORTANT]
====
SSE 이벤트 payload는 "화면에 바로 렌더링"하기보다,
- 메시지/알림 API를 재조회해서 서버 상태와 1:1로 맞추는 방식이 운영에 가장 안정적입니다.
====

---

==== 3-6) 401/재연결 권장 규칙 (쿠키 + refresh-cookie)

SSE 연결 중 인증 문제가 생기면(401):
1) `POST /api/auth/refresh-cookie`
2) 성공 시 SSE 재구독
3) 실패 시 로그아웃 처리

네트워크 단절/서버 재시작 등(5xx/네트워크 에러):
- 일정 backoff로 자동 재연결
- 가능하면 마지막으로 받은 이벤트 ID를 저장해 `Last-Event-ID`로 전달(누락 replay)

[NOTE]
====
현재 서버는 구독 시 `Last-Event-ID`를 받아 누락 이벤트 replay를 시도합니다.
====

---

=== FAQ

==== Q1. 401이 반복돼요
- SPA면 `withCredentials: true`가 꺼졌을 가능성이 큽니다.
- 운영 HTTPS라면 `Secure=true` 쿠키가 아니면 브라우저가 막을 수 있습니다.
- 크로스 도메인이라면 `SameSite=None; Secure`가 필요할 수 있습니다.

==== Q2. SSE가 끊겨요
- 프록시에서 `proxy_buffering off`, `proxy_read_timeout`이 빠진 경우가 가장 흔합니다.
- 네트워크 변경에 대비해 클라이언트 자동 재연결이 필요합니다.

==== Q3. refresh-cookie는 언제 호출해요?
- 보통 “401 발생 시”에만 호출합니다.
- 원 요청은 1회만 재시도(무한 루프 방지)하세요.

== 1. Authentication

=== 로그인 (Bearer)
include::{snippets}/auth-login/http-request.adoc[]
include::{snippets}/auth-login/http-response.adoc[]

=== 토큰 재발급(Refresh, Bearer)
include::{snippets}/auth-refresh/http-request.adoc[]
include::{snippets}/auth-refresh/http-response.adoc[]

==== 실패: Refresh Token 재사용(401)
include::{snippets}/auth-refresh-401-reuse/http-request.adoc[]
include::{snippets}/auth-refresh-401-reuse/http-response.adoc[]

=== 전 기기 로그아웃 (Bearer)
include::{snippets}/auth-logout-all/http-request.adoc[]
include::{snippets}/auth-logout-all/http-response.adoc[]

=== 로그인 (Cookie)
include::{snippets}/auth-login-cookie/http-request.adoc[]
include::{snippets}/auth-login-cookie/http-response.adoc[]

=== 토큰 재발급 (Cookie)
include::{snippets}/auth-refresh-cookie/http-request.adoc[]
include::{snippets}/auth-refresh-cookie/http-response.adoc[]

=== 로그아웃 (Cookie)
include::{snippets}/auth-logout-cookie/http-request.adoc[]
include::{snippets}/auth-logout-cookie/http-response.adoc[]

=== 전 기기 로그아웃 (Cookie)
include::{snippets}/auth-logout-all-cookie/http-request.adoc[]
include::{snippets}/auth-logout-all-cookie/http-response.adoc[]

---

== 2. Users

[TIP]
====
**Users API 권장 흐름**
- 회원가입 → 로그인(쿠키 권장)
- 사용자 검색은 Cursor Paging → 응답에 nextCursor가 있으면 다음 페이지 조회에 사용
====

=== 회원가입
include::{snippets}/users-create/http-request.adoc[]
include::{snippets}/users-create/http-response.adoc[]

==== 실패: 400 Validation
include::{snippets}/users-create-400-validation/http-request.adoc[]
include::{snippets}/users-create-400-validation/http-response.adoc[]

==== 실패: 409 Duplicate Email
include::{snippets}/users-create-409-duplicate-email/http-request.adoc[]
include::{snippets}/users-create-409-duplicate-email/http-response.adoc[]

==== 실패: 409 Duplicate Handle
include::{snippets}/users-create-409-duplicate-handle/http-request.adoc[]
include::{snippets}/users-create-409-duplicate-handle/http-response.adoc[]

=== 사용자 검색 (Cursor Paging)
include::{snippets}/users-search-200/http-request.adoc[]
include::{snippets}/users-search-200/http-response.adoc[]

==== 다음 페이지 조회 예시
include::{snippets}/users-search-200-next-page/http-request.adoc[]
include::{snippets}/users-search-200-next-page/http-response.adoc[]

==== 팔로잉 여부 포함 예시
include::{snippets}/users-search-200-following-flag/http-request.adoc[]
include::{snippets}/users-search-200-following-flag/http-response.adoc[]

==== 실패: q blank(400)
include::{snippets}/users-search-400-q-blank/http-request.adoc[]
include::{snippets}/users-search-400-q-blank/http-response.adoc[]

==== 실패: size range(400)
include::{snippets}/users-search-400-size-range/http-request.adoc[]
include::{snippets}/users-search-400-size-range/http-response.adoc[]

=== 프로필 조회
include::{snippets}/users-profile-get/http-request.adoc[]
include::{snippets}/users-profile-get/http-response.adoc[]

---

== 3. Me

=== 내 정보 조회
include::{snippets}/me-200-ok/http-request.adoc[]
include::{snippets}/me-200-ok/http-response.adoc[]

==== 실패: 401 Unauthorized
include::{snippets}/me-401-unauthorized/http-request.adoc[]
include::{snippets}/me-401-unauthorized/http-response.adoc[]

=== 내 프로필 수정
include::{snippets}/me-profile-update/http-request.adoc[]
include::{snippets}/me-profile-update/http-response.adoc[]

==== 실패: 다른 유저 파일 사용(403)
include::{snippets}/me-profile-update-403-forbidden-file/http-request.adoc[]
include::{snippets}/me-profile-update-403-forbidden-file/http-response.adoc[]

---

== 4. Files

[NOTE]
====
다운로드/썸네일은 ETag(304)를 활용하면 트래픽/로딩을 줄일 수 있습니다.
====

=== 파일 업로드
include::{snippets}/files-upload/http-request.adoc[]
include::{snippets}/files-upload/http-response.adoc[]

=== 파일 다운로드 (브라우저 렌더링)
include::{snippets}/files-download-200/http-request.adoc[]
include::{snippets}/files-download-200/http-response.adoc[]

==== 304 Not Modified (ETag)
include::{snippets}/files-download-304/http-request.adoc[]
include::{snippets}/files-download-304/http-response.adoc[]

=== 썸네일 조회
include::{snippets}/files-thumbnail-200/http-request.adoc[]
include::{snippets}/files-thumbnail-200/http-response.adoc[]

==== 304 Not Modified (ETag)
include::{snippets}/files-thumbnail-304/http-request.adoc[]
include::{snippets}/files-thumbnail-304/http-response.adoc[]

---

== 5. Follows

=== 팔로우
include::{snippets}/follows-create/http-request.adoc[]
include::{snippets}/follows-create/http-response.adoc[]

==== 실패: 자기 자신 팔로우(400)
include::{snippets}/follows-create-400-self/http-request.adoc[]
include::{snippets}/follows-create-400-self/http-response.adoc[]

=== 언팔로우
include::{snippets}/follows-delete/http-request.adoc[]
include::{snippets}/follows-delete/http-response.adoc[]

---

== 6. Posts

[TIP]
====
게시글에 파일이 포함된다면, 먼저 Files 업로드로 fileId 확보 후 Posts에서 참조하는 흐름을 권장합니다.
====

=== 게시글 생성
include::{snippets}/posts-create/http-request.adoc[]
include::{snippets}/posts-create/http-response.adoc[]

=== 게시글 단건 조회
include::{snippets}/posts-get/http-request.adoc[]
include::{snippets}/posts-get/http-response.adoc[]

=== 게시글 삭제
include::{snippets}/posts-delete/http-request.adoc[]
include::{snippets}/posts-delete/http-response.adoc[]

---

== 7. Post Likes

=== 좋아요
include::{snippets}/post-likes-create-204/http-request.adoc[]
include::{snippets}/post-likes-create-204/http-response.adoc[]

=== 좋아요 취소
include::{snippets}/post-likes-delete-204/http-request.adoc[]
include::{snippets}/post-likes-delete-204/http-response.adoc[]

---

== 8. Comments

=== 댓글 생성(201)
include::{snippets}/comments-create-201/http-request.adoc[]
include::{snippets}/comments-create-201/http-response.adoc[]

==== 실패: 내용 비어있음(400)
include::{snippets}/comments-create-400-content-blank/http-request.adoc[]
include::{snippets}/comments-create-400-content-blank/http-response.adoc[]

=== 댓글 목록(200)
include::{snippets}/comments-list-200/http-request.adoc[]
include::{snippets}/comments-list-200/http-response.adoc[]

==== 다음 페이지 예시
include::{snippets}/comments-list-200-next-page/http-request.adoc[]
include::{snippets}/comments-list-200-next-page/http-response.adoc[]

==== 다음 페이지 followup 예시
include::{snippets}/comments-list-200-next-page-followup/http-request.adoc[]
include::{snippets}/comments-list-200-next-page-followup/http-response.adoc[]

==== 실패: invalid cursor(400)
include::{snippets}/comments-list-400-invalid-cursor/http-request.adoc[]
include::{snippets}/comments-list-400-invalid-cursor/http-response.adoc[]

=== 댓글 삭제(204)
include::{snippets}/comments-delete-204/http-request.adoc[]
include::{snippets}/comments-delete-204/http-response.adoc[]

==== 실패: invalid uuid(400)
include::{snippets}/comments-delete-400-invalid-uuid/http-request.adoc[]
include::{snippets}/comments-delete-400-invalid-uuid/http-response.adoc[]

---

== 9. Feed

=== 피드 조회
include::{snippets}/feed-get/http-request.adoc[]
include::{snippets}/feed-get/http-response.adoc[]

==== 다음 페이지 예시
include::{snippets}/feed-get-next-page/http-request.adoc[]
include::{snippets}/feed-get-next-page/http-response.adoc[]

---

== 10. Conversations & Messages

[TIP]
====
권장 사용 흐름
- 대화방 생성/조회 → 목록 조회
- 메시지 조회/전송
- 실시간 갱신은 SSE 이벤트 수신 후 필요한 API만 재조회하는 방식 권장
====

=== 대화방 생성/조회(DIRECT)
include::{snippets}/conversations-direct-200/http-request.adoc[]
include::{snippets}/conversations-direct-200/http-response.adoc[]

=== 대화방 목록
include::{snippets}/conversations-list/http-request.adoc[]
include::{snippets}/conversations-list/http-response.adoc[]

==== 다음 페이지 예시
include::{snippets}/conversations-list-200-next-page/http-request.adoc[]
include::{snippets}/conversations-list-200-next-page/http-response.adoc[]

==== 다음 페이지 followup 예시
include::{snippets}/conversations-list-200-next-page-followup/http-request.adoc[]
include::{snippets}/conversations-list-200-next-page-followup/http-response.adoc[]

=== 대화 읽음 처리(READ)
include::{snippets}/conversations-read/http-request.adoc[]
include::{snippets}/conversations-read/http-response.adoc[]

=== 안 읽은 메시지: before
include::{snippets}/conversations-unread-before/http-request.adoc[]
include::{snippets}/conversations-unread-before/http-response.adoc[]

=== 안 읽은 메시지: before (messages get)
include::{snippets}/conversations-unread-before-messages-get/http-request.adoc[]
include::{snippets}/conversations-unread-before-messages-get/http-response.adoc[]

=== 안 읽은 메시지: after
include::{snippets}/conversations-unread-after/http-request.adoc[]
include::{snippets}/conversations-unread-after/http-response.adoc[]

=== 안 읽은 메시지: after (messages get)
include::{snippets}/conversations-unread-after-messages-get/http-request.adoc[]
include::{snippets}/conversations-unread-after-messages-get/http-response.adoc[]

=== 메시지 전송
include::{snippets}/messages-send/http-request.adoc[]
include::{snippets}/messages-send/http-response.adoc[]

=== 메시지 목록
include::{snippets}/messages-get/http-request.adoc[]
include::{snippets}/messages-get/http-response.adoc[]

==== 다음 페이지 예시
include::{snippets}/messages-get-next-page/http-request.adoc[]
include::{snippets}/messages-get-next-page/http-response.adoc[]

==== 자동 읽음 처리 예시
include::{snippets}/messages-get-auto-read/http-request.adoc[]
include::{snippets}/messages-get-auto-read/http-response.adoc[]

==== 실패: 대화방 없음(404)
include::{snippets}/messages-get-404-conversation-not-found/http-request.adoc[]
include::{snippets}/messages-get-404-conversation-not-found/http-response.adoc[]

=== 메시지 숨김
include::{snippets}/message-hide/http-request.adoc[]
include::{snippets}/message-hide/http-response.adoc[]

=== 메시지 삭제(모두에게)
include::{snippets}/message-delete-for-all/http-request.adoc[]
include::{snippets}/message-delete-for-all/http-response.adoc[]

=== 대화 핀 목록(ACTIVE)
include::{snippets}/conversation-pins-get/http-request.adoc[]
include::{snippets}/conversation-pins-get/http-response.adoc[]

---

== 11. Notifications

[NOTE]
====
SSE 이벤트로 새 알림을 감지한 뒤, 화면에서는 알림 목록 API를 재조회하는 패턴을 권장합니다.
====

=== 알림 목록
include::{snippets}/notifications-get-200/http-request.adoc[]
include::{snippets}/notifications-get-200/http-response.adoc[]

==== 다음 페이지 예시
include::{snippets}/notifications-get-200-next-page/http-request.adoc[]
include::{snippets}/notifications-get-200-next-page/http-response.adoc[]

=== 알림 읽음 처리
include::{snippets}/notifications-read-200/http-request.adoc[]
include::{snippets}/notifications-read-200/http-response.adoc[]

=== 알림 전체 읽음 처리
include::{snippets}/notifications-read-all-200/http-request.adoc[]
include::{snippets}/notifications-read-all-200/http-response.adoc[]

=== 알림 삭제/읽음처리(200)
include::{snippets}/notifications-delete-read-200/http-request.adoc[]
include::{snippets}/notifications-delete-read-200/http-response.adoc[]

---

== 12. SSE

[IMPORTANT]
====
SSE 구독 엔드포인트는 인증이 필요합니다.
브라우저에서는 `withCredentials: true`가 필요하고, 가능하면 Cookie 방식(동일 오리진)을 권장합니다.
====

[TIP]
====
프록시/nginx 환경에서는 SSE 버퍼링이 끊김의 원인이 될 수 있어
`proxy_buffering off`, `proxy_read_timeout` 등을 권장합니다.
(현재 프로젝트 nginx는 `/api/sse/`에 대해 buffering off 설정이 포함되어 있습니다.)
====

=== SSE 구독
include::{snippets}/sse-subscribe/http-request.adoc[]
include::{snippets}/sse-subscribe/http-response.adoc[]